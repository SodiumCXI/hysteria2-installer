#!/bin/bash
set -euo pipefail

[ "$EUID" -ne 0 ] && { echo "error: run as root"; exit 1; }

STATE_FILE="/etc/hysteria/.state"
CONFIG_FILE="/etc/hysteria/config.yaml"

rand() { tr -dc 'A-Za-z0-9' </dev/urandom | head -c "$1"; true; }
die()  { echo "error: $*"; exit 1; }

[ ! -f "$STATE_FILE" ] && die "hysteria2 is not installed"
source "$STATE_FILE"

_build_uri() {
  local uri="hysteria2://${AUTH_PASS}@${SERVER_IP}:${PORT}?obfs=salamander&obfs-password=${OBFS_PASS}"
  [ "${CERT_MODE}" != "2" ] && uri="${uri}&insecure=1"
  echo "$uri"
}

_write_state() {
  cat > "$STATE_FILE" <<STATE
SERVER_IP="${SERVER_IP}"
PORT="${PORT}"
AUTH_PASS="${AUTH_PASS}"
OBFS_PASS="${OBFS_PASS}"
MASQ_URL="${MASQ_URL}"
CERT_MODE="${CERT_MODE}"
STATE
  chmod 600 "$STATE_FILE"
}

_write_config() {
  cat > "$CONFIG_FILE" <<CONF
listen: :${PORT}

tls:
  cert: /etc/hysteria/server.crt
  key: /etc/hysteria/server.key

auth:
  type: password
  password: ${AUTH_PASS}

masquerade:
  type: proxy
  proxy:
    url: ${MASQ_URL}
    rewriteHost: true

obfs:
  type: salamander
  salamander:
    password: ${OBFS_PASS}
CONF
}

_restart() {
  systemctl restart hysteria-server
  sleep 1
  systemctl is-active --quiet hysteria-server \
    || die "service failed  →  journalctl -u hysteria-server -n 50"
}

_regen_certs() {
  local mode="$1"
  if [ "$mode" = "2" ]; then
    read -rp "ca name [MyVPN-CA]: " _in; local CA_NAME="${_in:-MyVPN-CA}"
    openssl genrsa -out /etc/hysteria/ca.key 2048 2>/dev/null
    openssl req -x509 -new -nodes \
      -key /etc/hysteria/ca.key -sha256 -days 36500 \
      -out /etc/hysteria/ca.crt \
      -subj "/CN=${CA_NAME}" 2>/dev/null
    openssl genrsa -out /etc/hysteria/server.key 2048 2>/dev/null
    openssl req -new \
      -key /etc/hysteria/server.key \
      -out /etc/hysteria/server.csr \
      -subj "/CN=${SERVER_IP}" 2>/dev/null
    openssl x509 -req \
      -in /etc/hysteria/server.csr \
      -CA /etc/hysteria/ca.crt -CAkey /etc/hysteria/ca.key \
      -CAcreateserial -out /etc/hysteria/server.crt \
      -days 36500 -sha256 2>/dev/null
    rm -f /etc/hysteria/server.csr
  else
    openssl req -x509 -nodes -newkey rsa:2048 \
      -keyout /etc/hysteria/server.key \
      -out /etc/hysteria/server.crt \
      -days 36500 -subj "/CN=localhost" 2>/dev/null
  fi
  chown hysteria:hysteria /etc/hysteria/server.key /etc/hysteria/server.crt
  chmod 600 /etc/hysteria/server.key
  chmod 644 /etc/hysteria/server.crt
}

_print_ca() {
  if [ "${CERT_MODE}" = "2" ] && [ -f /etc/hysteria/ca.crt ]; then
    echo ""
    echo "ca certificate  →  save as hysteria-ca.crt and import on client"
    echo ""
    cat /etc/hysteria/ca.crt
    echo ""
    echo "windows  win+r → certmgr.msc → trusted root certification authorities"
    echo "         right click → all tasks → import → select hysteria-ca.crt"
  fi
}

cmd_help() {
  echo ""
  echo "h2  hysteria2 management"
  echo ""
  echo "  status     service status"
  echo "  key        connection uri"
  echo "  modify     change settings"
  echo "  uninstall  remove everything"
  echo "  help       this message"
  echo ""
}

cmd_status() {
  local active enabled up_since
  active=$(systemctl is-active hysteria-server 2>/dev/null || echo "inactive")
  enabled=$(systemctl is-enabled hysteria-server 2>/dev/null || echo "disabled")
  up_since=$(systemctl show hysteria-server --property=ActiveEnterTimestamp \
    | cut -d= -f2 2>/dev/null || echo "n/a")

  echo ""
  echo "status    $active"
  echo "autostart $enabled"
  echo "since     ${up_since:-n/a}"
  echo "ip        $SERVER_IP"
  echo "port      $PORT"
  echo "cert      $([ "${CERT_MODE}" = "2" ] && echo 'ca' || echo 'simple')"
  echo "masq      $MASQ_URL"
  echo ""
}

cmd_key() {
  echo ""
  _build_uri
  _print_ca
  echo ""
}

cmd_modify() {
  echo ""
  echo "leave blank to keep current, 'random' to regenerate password"
  echo ""

  read -rp "port           [${PORT}]: " _in
  [ -n "$_in" ] && PORT="$_in"

  read -rp "auth password  [${AUTH_PASS}]: " _in
  if   [ "$_in" = "random" ]; then AUTH_PASS=$(rand 16)
  elif [ -n "$_in" ];         then AUTH_PASS="$_in"; fi

  read -rp "obfs password  [${OBFS_PASS}]: " _in
  if   [ "$_in" = "random" ]; then OBFS_PASS=$(rand 16)
  elif [ -n "$_in" ];         then OBFS_PASS="$_in"; fi

  read -rp "masquerade url [${MASQ_URL}]: " _in
  [ -n "$_in" ] && MASQ_URL="$_in"

  echo ""
  echo "certificates"
  echo "  1  keep current"
  echo "  2  simple — self-signed, insecure=1"
  echo "  3  ca     — CA-signed, no insecure"
  echo ""
  read -rp "choose [1/2/3]: " _in
  local cert_choice="${_in:-1}"

  if [ "$cert_choice" = "2" ]; then
    CERT_MODE="1"
    echo ""
    echo "regenerating..."
    _regen_certs "1"
  elif [ "$cert_choice" = "3" ]; then
    CERT_MODE="2"
    echo ""
    echo "regenerating..."
    _regen_certs "2"
  fi

  echo ""
  echo "applying..."
  _write_config
  _write_state
  _restart
  echo ""
  _build_uri
  [ "$cert_choice" = "3" ] && _print_ca
  echo ""
}

cmd_uninstall() {
  echo ""
  read -rp "remove hysteria2 and all data? [y/N]: " _in
  [ "${_in,,}" != "y" ] && { echo "aborted"; exit 0; }
  echo ""

  systemctl stop hysteria-server    2>/dev/null || true
  systemctl disable hysteria-server 2>/dev/null || true
  bash <(curl -fsSL https://get.hy2.sh/) --remove >/dev/null 2>&1 || true
  rm -f /etc/systemd/system/multi-user.target.wants/hysteria-server.service
  rm -f /etc/systemd/system/multi-user.target.wants/hysteria-server@*.service
  systemctl daemon-reload
  id "hysteria" &>/dev/null && userdel -r hysteria 2>/dev/null || true
  rm -rf /etc/hysteria

  if command -v ufw &>/dev/null; then
    ufw delete allow "${PORT}/udp" >/dev/null 2>&1 || true
    ufw delete allow "${PORT}/tcp" >/dev/null 2>&1 || true
  fi

  rm -f /usr/local/bin/h2
  echo "removed"
  echo ""
}

case "${1:-help}" in
  status)    cmd_status    ;;
  key)       cmd_key       ;;
  modify)    cmd_modify    ;;
  uninstall) cmd_uninstall ;;
  help)      cmd_help      ;;
  *) echo "unknown command: ${1}"; cmd_help; exit 1 ;;
esac
