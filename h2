#!/bin/bash
set -euo pipefail

[ "$EUID" -ne 0 ] && { echo "Error: run as root"; exit 1; }

STATE_FILE="/etc/hysteria/.state"
CONFIG_FILE="/etc/hysteria/config.yaml"

rand() { tr -dc 'A-Za-z0-9' </dev/urandom | head -c "$1"; true; }
die()  { echo "Error: $*"; exit 1; }

[ ! -f "$STATE_FILE" ] && die "Hysteria2 is not installed"
source "$STATE_FILE"

_build_uri() {
  local sni="${MASQ_URL#https://}"; sni="${sni%/}"
  local uri="hysteria2://${AUTH_PASS}@${SERVER_IP}:${PORT}?sni=${sni}&obfs=salamander&obfs-password=${OBFS_PASS}"
  [ "${CERT_MODE}" != "2" ] && uri="${uri}&insecure=1"
  uri="${uri}#${KEY_NAME}"
  echo "$uri"
}

_write_state() {
  cat > "$STATE_FILE" <<STATE
SERVER_IP="${SERVER_IP}"
PORT="${PORT}"
AUTH_PASS="${AUTH_PASS}"
OBFS_PASS="${OBFS_PASS}"
MASQ_URL="${MASQ_URL}"
CERT_MODE="${CERT_MODE}"
STATE
  chmod 600 "$STATE_FILE"
}

_write_config() {
  cat > "$CONFIG_FILE" <<CONF
listen: :${PORT}

tls:
  cert: /etc/hysteria/server.crt
  key: /etc/hysteria/server.key

auth:
  type: password
  password: ${AUTH_PASS}

masquerade:
  type: proxy
  proxy:
    url: ${MASQ_URL}
    rewriteHost: true

obfs:
  type: salamander
  salamander:
    password: ${OBFS_PASS}
CONF
}

_restart() {
  systemctl restart hysteria-server
  sleep 1
  systemctl is-active --quiet hysteria-server \
    || die "Service failed. Check: journalctl -u hysteria-server -n 50"
}

_regen_certs() {
  local mode="$1"
  if [ "$mode" = "2" ]; then
    read -rp "CA name [Hysteria2-CA]: " _in; local CA_NAME="${_in:-Hysteria2-CA}"
    openssl genrsa -out /etc/hysteria/ca.key 2048 2>/dev/null
    openssl req -x509 -new -nodes \
      -key /etc/hysteria/ca.key -sha256 -days 36500 \
      -out /etc/hysteria/ca.crt \
      -subj "/CN=${CA_NAME}" 2>/dev/null
    openssl genrsa -out /etc/hysteria/server.key 2048 2>/dev/null
    openssl req -new \
      -key /etc/hysteria/server.key \
      -out /etc/hysteria/server.csr \
      -subj "/CN=${SERVER_IP}" 2>/dev/null
    openssl x509 -req \
      -in /etc/hysteria/server.csr \
      -CA /etc/hysteria/ca.crt -CAkey /etc/hysteria/ca.key \
      -CAcreateserial -out /etc/hysteria/server.crt \
      -days 36500 -sha256 2>/dev/null
    rm -f /etc/hysteria/server.csr
  else
    openssl req -x509 -nodes -newkey rsa:2048 \
      -keyout /etc/hysteria/server.key \
      -out /etc/hysteria/server.crt \
      -days 36500 -subj "/CN=localhost" 2>/dev/null
  fi
  chown hysteria:hysteria /etc/hysteria/server.key /etc/hysteria/server.crt
  chmod 600 /etc/hysteria/server.key
  chmod 644 /etc/hysteria/server.crt
}

_print_ca() {
  if [ "${CERT_MODE}" = "2" ] && [ -f /etc/hysteria/ca.crt ]; then
    echo ""
    echo "CA Certificate — save as hysteria-ca.crt and import on client:"
    echo ""
    cat /etc/hysteria/ca.crt
    echo ""
  fi
}

cmd_help() {
  echo "  status     Service status"
  echo "  key        Connection URI"
  echo "  modify     Change settings"
  echo "  uninstall  Remove everything"
  echo "  help       This message"
}

cmd_status() {
  local active enabled up_since
  active=$(systemctl is-active hysteria-server 2>/dev/null || echo "inactive")
  enabled=$(systemctl is-enabled hysteria-server 2>/dev/null || echo "disabled")
  up_since=$(systemctl show hysteria-server --property=ActiveEnterTimestamp \
    | cut -d= -f2 2>/dev/null || echo "n/a")

  echo ""
  echo "Status     $active"
  echo "Autostart  $enabled"
  echo "Since      ${up_since:-n/a}"
  echo "IP         $SERVER_IP"
  echo "Port       $PORT"
  echo "Cert       $([ "${CERT_MODE}" = "2" ] && echo 'CA-signed' || echo 'Self-signed')"
  echo "SNI        $(echo "$MASQ_URL" | sed 's|https://||;s|/||g')"
  echo "Key name   $KEY_NAME"
  echo ""
}

cmd_key() {
  echo ""
  _build_uri
  _print_ca
  echo ""
}

cmd_modify() {
  echo "Leave blank to keep current, 'random' to regenerate password."

  read -rp "Port [${PORT}]: " _in; [ -n "$_in" ] && PORT="$_in"
  read -rp "Auth password [${AUTH_PASS}]: " _in
  if   [ "$_in" = "random" ]; then AUTH_PASS=$(rand 16)
  elif [ -n "$_in" ];         then AUTH_PASS="$_in"; fi
  read -rp "Obfs password [${OBFS_PASS}]: " _in
  if   [ "$_in" = "random" ]; then OBFS_PASS=$(rand 16)
  elif [ -n "$_in" ];         then OBFS_PASS="$_in"; fi
  local masq_display="${MASQ_URL#https://}"; masq_display="${masq_display%/}"
  read -rp "SNI [${masq_display}]: " _in
  if [ -n "$_in" ]; then MASQ_URL="https://${_in}/"; fi
  read -rp "Key name [${KEY_NAME}]: " _in; [ -n "$_in" ] && KEY_NAME="$_in"

  echo "Certificates:"
  echo "  1 Keep current"
  echo "  2 Simple — self-signed, insecure=1"
  echo "  3 CA — CA-signed, no insecure"
  read -rp "Choose [1/2/3]: " _in
  local cert_choice="${_in:-1}"

  if [ "$cert_choice" = "2" ]; then
    CERT_MODE="1"
    echo "Regenerating certificates..."
    _regen_certs "1"
    echo "Done."
  elif [ "$cert_choice" = "3" ]; then
    CERT_MODE="2"
    echo "Regenerating certificates..."
    _regen_certs "2"
    echo "Done."
  fi

  echo "Applying changes..."
  _write_config
  _write_state
  _restart
  echo "Done."

  echo ""
  _build_uri
  [ "$cert_choice" = "3" ] && _print_ca
  echo ""
}

cmd_uninstall() {
  read -rp "Remove Hysteria2 and all data? [y/n]: " _in
  [ "${_in,,}" != "y" ] && { echo "Aborted."; exit 0; }

  echo "Stopping service..."
  systemctl stop hysteria-server 2>/dev/null || true
  systemctl disable hysteria-server 2>/dev/null || true
  echo "Done."

  echo "Removing Hysteria2 binary..."
  bash <(curl -fsSL https://get.hy2.sh/) --remove >/dev/null 2>&1 || true
  echo "Done."

  echo "Removing systemd units..."
  rm -f /etc/systemd/system/multi-user.target.wants/hysteria-server.service
  rm -f /etc/systemd/system/multi-user.target.wants/hysteria-server@*.service
  systemctl daemon-reload
  echo "Done."

  echo "Removing hysteria user..."
  if id "hysteria" &>/dev/null; then
    userdel -r hysteria 2>/dev/null || userdel hysteria 2>/dev/null || true
    echo "Done."
  else
    echo "User not found, skipping."
  fi

  echo "Removing config and certificates..."
  rm -rf /etc/hysteria
  echo "Done."

  if command -v ufw &>/dev/null; then
    echo "Removing firewall rules..."
    ufw delete allow "${PORT}/udp" >/dev/null 2>&1 || true
    ufw delete allow "${PORT}/tcp" >/dev/null 2>&1 || true
    echo "Done."
  fi

  echo "Removing h2..."
  rm -f /usr/local/bin/h2
  echo "Done."

  echo ""
  echo "Hysteria2 removed."
  echo ""
}

case "${1:-help}" in
  status)    cmd_status    ;;
  key)       cmd_key       ;;
  modify)    cmd_modify    ;;
  uninstall) cmd_uninstall ;;
  help)      cmd_help      ;;
  *) echo "Unknown command: ${1}"; cmd_help; exit 1 ;;
esac